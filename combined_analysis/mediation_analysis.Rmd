---
title: "Generalized IPW"
author: "Xiaoting Chen"
date: "2024-04-23"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## Prep

### packages
```{r, warning=FALSE}
library(readr)
library(tidyr)
library(ggplot2)
library(dplyr)
library(stats) # handle normal distribution calculations
library(splines) # using splines
library(mgcv)
```

### data

```{r}
all_combos <- readRDS("all_combos.rds")

```

```{r}
analysis_feature <- c('cvd_10y_HF', 'cvd_10y_noHF', 'nSES', 'nFavFood', 'nPhysFac', 'nRS',
                      'FamIncome', 'nutrition', 'PhysAct', 'currentSmoker', 'alc',
                      'age', 'gender', 'Diabetes', 'hdl', 'totchol', 'sbp',
                      'site', 'race')

ind_feature_map <- c('0' = 1, '1' = 2, '2' = 3)
```

```{r}
mesa_std <- read.csv('../data_processed/MESA/mesa_std.csv')

mesa_std <- mesa_std %>%
  select(analysis_feature) %>%
  mutate(# # treat ind behavirol variables as conitnuous, avoid partial significant 
    Diabetes = as.factor(Diabetes),
         site = as.factor(site),
         race = as.factor(race)) %>%
  mutate( # recode to avoid 0
    nutrition = recode(nutrition, !!!ind_feature_map),
    PhysAct = recode(PhysAct, !!!ind_feature_map),
    currentSmoker = recode(currentSmoker, !!!ind_feature_map),
    alc = recode(alc, !!!ind_feature_map)
  )

mesa_bla_std <- mesa_std[mesa_std$race == 1, ] %>%
  select(-race)
```

```{r}
jhs_std <- read.csv('../data_processed/JHS/jhs_std.csv')

analysis_feature <- c('cvd_10y_HF', 'cvd_10y_noHF', 'nSES', 'nFavFood', 'nPhysFac', 'nRS',
                      'FamIncome', 'nutrition', 'PhysAct', 'currentSmoker', 'alc',
                      'age', 'gender', 'Diabetes', 'hdl', 'totchol', 'sbp')

jhs_std <- jhs_std %>%
  select(analysis_feature) %>%
  mutate(# # treat ind behavirol variables as conitnuous, avoid partial significant 
    Diabetes = as.factor(Diabetes)) %>%
  mutate( # recode to avoid 0
    nutrition = recode(nutrition, !!!ind_feature_map),
    PhysAct = recode(PhysAct, !!!ind_feature_map),
    currentSmoker = recode(currentSmoker, !!!ind_feature_map),
    alc = recode(alc, !!!ind_feature_map)
  )
```

```{r}
named_datasets <- list(mesa = mesa_std, mesa_bla = mesa_bla_std,jhs = jhs_std)
names(named_datasets) <- c("mesa", "mesa_bla","jhs")
```

### function    
```{r}
conditional_densities <- function(data, treatment, formula_ps_no_con, formula_ps_con, use_confounders = TRUE) {

  formula <- if(use_confounders) formula_ps_con else formula_ps_no_con
  
  # Fit the linear model
  model <- lm(as.formula(formula), data = data)
  
  # Calculate the fitted values and standard deviation of residuals
  fitted_values <- fitted(model)
  resid_std <- sd(resid(model))
  
  # Calculate the density of treatment under a normal distribution with parameters from the model
  densities <- dnorm(data[[treatment]], mean = fitted_values, sd = resid_std)
  
  # Return the densities as a vector indexed similarly to the fitted values
  return(setNames(densities, names(fitted_values)))
}

```



## loop to generate result

**Steps:**\\
1. calculate weights \\
2. Y ~ b0 + b1X + bZ + e (Z represents all the other covariates)\\
3. M ~ b0 + b2X + e\\
4. Y ~ b0 + b3X + b4M + bZ + e\\


### estimate
```{r, warning=FALSE}
report_df <- data.frame(
  Data = character(),
  Y = character(),
  X = character(),
  mediator = character(),
  b1 = numeric(),
  b1_pvalue = numeric(),
  b2 = numeric(),
  b2_pvalue = numeric(),
  b3 = numeric(),
  b3_pvalue = numeric(),
  b4 = numeric(),
  b4_pvalue = numeric(),
  stringsAsFactors = FALSE 
)

for (combo in all_combos) {
  
  # get values
  data_name = combo$data
  data <- named_datasets[[data_name]]
  Y <- combo$Y
  X <- combo$X
  M <- combo$M
  Z <- combo$covariates_final
  
  # generate formula
  ## formula for generating weights
  formula_ps_no_str <- paste(X, "~ 1")
  formula_ps_no <- as.formula(formula_ps_no_str)
  formula_ps_str <- paste(X, "~ ", M, "+" ,paste(Z, collapse=" + "))
  formula_ps <- as.formula(formula_ps_str)
  ## formula for mediation test
  formula_X_to_Y <- paste(Y, "~",X, "+", paste(Z, collapse=" + "))
  formula_X_to_Y <- as.formula(formula_X_to_Y)
  formula_X_to_M <- paste(M, "~", X)
  formula_X_to_M <- as.formula(formula_X_to_M)
  formula_XM_to_Y <- paste(Y, "~",X, "+", M, "+", paste(Z, collapse=" + "))
  formula_XM_to_Y <- as.formula(formula_XM_to_Y)
  
  
  # estimate weights
  
  denominator = conditional_densities(data, X, formula_ps_no,formula_ps, use_confounders=T)
  numerator = conditional_densities(data,X, formula_ps_no,formula_ps, use_confounders=F)
  propensity_density = numerator / denominator
  threshold <- quantile(propensity_density, 0.99)
  data <- data[propensity_density <= threshold, ]
  propensity_density <- propensity_density[propensity_density <= threshold]
  
  # run the 3 models
  ## Y ~ X + Z
  mod_X_to_Y <- glm(formula = formula_X_to_Y, data = data, family = binomial(), weights = propensity_density)
  summary_X_to_Y <- summary(mod_X_to_Y)
  coef_X_to_Y <- summary_X_to_Y$coefficients
  ## M ~ X
  mod_X_to_M <- glm(formula = formula_X_to_M, data = data, weights = propensity_density)
  summary_X_to_M <- summary(mod_X_to_M)
  coef_X_to_M <- summary_X_to_M$coefficients
  ## Y ~ X + M +Z
  mod_XM_to_Y <- glm(formula = formula_XM_to_Y, data = data, family = binomial(), weights = propensity_density)
  summary_XM_to_Y <- summary(mod_XM_to_Y)
  coef_XM_to_Y <- summary_XM_to_Y$coefficients
  
  
  ###### store model result
  b1 <- round(coef_X_to_Y[X, "Estimate"], digits = 5)
  b1_pvalue <- round(coef_X_to_Y[X, "Pr(>|z|)"], digits = 5)
  b2 <- round(coef_X_to_M[X, "Estimate"], digits = 5)
  b2_pvalue <- round(coef_X_to_M[X, "Pr(>|t|)"], digits = 5)
  b3 <- round(coef_XM_to_Y[X, "Estimate"], digits = 5)
  b3_pvalue <- round(coef_XM_to_Y[X, "Pr(>|z|)"], digits = 5)
  b4 <- round(coef_XM_to_Y[M, "Estimate"], digits = 5)
  b4_pvalue <- round(coef_XM_to_Y[M, "Pr(>|z|)"], digits = 5)
  
  new_df <- data.frame(
              Data = data_name,
              Y = Y,
              X = X,
              mediator = M,
              b1 = b1,
              b1_pvalue = b1_pvalue,
              b2 = b2,
              b2_pvalue = b2_pvalue,
              b3 = b3,
              b3_pvalue = b3_pvalue,
              b4 = b4,
              b4_pvalue = b4_pvalue,
              stringsAsFactors = FALSE )

  report_df <- rbind(report_df, new_df)

}

```

```{r}
# significant mediator
significant_mediat <- report_df %>%
  filter(b1_pvalue <= 0.05,
         b2_pvalue <= 0.05,
         b4_pvalue <= 0.05) %>%
  mutate(ADE = b3,
         ACME = b2*b3,
         Total_effect = b1) %>%
  select(-c(5:12))
```

```{r}
write.csv(significant_mediat, "../results/mediation_result/significant_mediat.csv", row.names = FALSE)
write.csv(report_df, "../results/mediation_result/mediation_result_complete.csv", row.names = FALSE)
```

