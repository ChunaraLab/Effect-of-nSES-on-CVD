---
title: "Generalized IPW"
author: "Xiaoting Chen"
date: "2024-04-23"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This file is translated from the Generalized_IPW.ipynb file and expanded on the spline function and prediction curve generation.\


## Prep

### packages
```{r, warning=FALSE}
library(readr)
library(tidyr)
library(ggplot2)
library(dplyr)
library(stats) # handle normal distribution calculations
library(splines) # using splines
library(mgcv)
```

### data

```{r}
all_combos <- readRDS("all_combos.rds")

# read in moderation results
significant_moderation <- read.csv("../results/moderation_result/moderation_result.csv") %>%
  filter(significant == "Y") %>%
  select(1:4) %>%
  rename(data_name = Data,
         M = moderator)
```

```{r}
analysis_feature <- c('cvd_10y_HF', 'cvd_10y_noHF', 'nSES', 'nFavFood', 'nPhysFac', 'nRS',
                      'FamIncome', 'nutrition', 'PhysAct', 'currentSmoker', 'alc',
                      'age', 'gender', 'Diabetes', 'hdl', 'totchol', 'sbp',
                      'site', 'race')

ind_feature_map <- c('0' = 1, '1' = 2, '2' = 3)
```

```{r}
mesa_std <- read.csv('../data_processed/MESA/mesa_std.csv')

mesa_std <- mesa_std %>%
  select(analysis_feature) %>%
  mutate(# # treat ind behavirol variables as conitnuous, avoid partial significant 
    Diabetes = as.factor(Diabetes),
         site = as.factor(site),
         race = as.factor(race)) %>%
  mutate( # recode to avoid 0
    nutrition = recode(nutrition, !!!ind_feature_map),
    PhysAct = recode(PhysAct, !!!ind_feature_map),
    currentSmoker = recode(currentSmoker, !!!ind_feature_map),
    alc = recode(alc, !!!ind_feature_map)
  )

mesa_bla_std <- mesa_std[mesa_std$race == 1, ] %>%
  select(-race)
```

```{r}
jhs_std <- read.csv('../data_processed/JHS/jhs_std.csv')

analysis_feature <- c('cvd_10y_HF', 'cvd_10y_noHF', 'nSES', 'nFavFood', 'nPhysFac', 'nRS',
                      'FamIncome', 'nutrition', 'PhysAct', 'currentSmoker', 'alc',
                      'age', 'gender', 'Diabetes', 'hdl', 'totchol', 'sbp')

jhs_std <- jhs_std %>%
  select(analysis_feature) %>%
  mutate(# # treat ind behavirol variables as conitnuous, avoid partial significant 
    Diabetes = as.factor(Diabetes)) %>%
  mutate( # recode to avoid 0
    nutrition = recode(nutrition, !!!ind_feature_map),
    PhysAct = recode(PhysAct, !!!ind_feature_map),
    currentSmoker = recode(currentSmoker, !!!ind_feature_map),
    alc = recode(alc, !!!ind_feature_map)
  )
```

```{r}
named_datasets <- list(mesa = mesa_std, mesa_bla = mesa_bla_std,jhs = jhs_std)
names(named_datasets) <- c("mesa", "mesa_bla","jhs")
```

### function    
```{r}
conditional_densities <- function(data, treatment, formula_ps_no_con, formula_ps_con, use_confounders = TRUE) {

  formula <- if(use_confounders) formula_ps_con else formula_ps_no_con
  
  # Fit the linear model
  model <- lm(as.formula(formula), data = data)
  
  # Calculate the fitted values and standard deviation of residuals
  fitted_values <- fitted(model)
  resid_std <- sd(resid(model))
  
  # Calculate the density of treatment under a normal distribution with parameters from the model
  densities <- dnorm(data[[treatment]], mean = fitted_values, sd = resid_std)
  
  # Return the densities as a vector indexed similarly to the fitted values
  return(setNames(densities, names(fitted_values)))
}

```


## single estimate - Generalized IPW 

### estimate

define model
```{r}
# mesa
data <- mesa_std
treatment = "nSES"
formula_ps_no = "nSES ~ 1"

formula_ps = "nSES ~ 1 + nRS + nFavFood + nPhysFac + \
                FamIncome + nutrition + PhysAct + currentSmoker + alc + \
                sbp + Diabetes + hdl + totchol + age + \
                site + race"

formula_outcome_logit = 'cvd_10y_HF ~ 1 + nSES'
```

```{r}
# jhs
data <- jhs_std
treatment = "nSES"
formula_ps_no = "nSES ~ 1"

formula_ps = "nSES ~ 1 + nRS + nFavFood + nPhysFac + \
                FamIncome + nutrition + PhysAct + currentSmoker + alc + \
                sbp + Diabetes + hdl + totchol + age"

formula_outcome_logit = 'cvd_10y_HF ~ 1 + nSES'
```

Step 1: estimate propensity density
```{r}
denominator = conditional_densities(data, treatment, formula_ps_no,formula_ps, use_confounders=T)
numerator = conditional_densities(data,treatment, formula_ps_no,formula_ps, use_confounders=F)
propensity_density = numerator / denominator

# exclude extreme values
threshold <- quantile(propensity_density, 0.99)
data <- data[propensity_density <= threshold, ]
propensity_density <- propensity_density[propensity_density <= threshold]
```

Step 2: Outcome model

modelA: weighted logit regression
```{r}
modelA <- glm(formula = formula_outcome_logit, data = data, family = binomial(), weights = propensity_density)
summary(modelA)
```

modelB: using glm spline
```{r}
# formula_outcome_sp = 'cvd_10y_HF ~ ns(nSES, df=4)'

modelB <- glm(formula = formula_outcome_sp, data = data, family = binomial(), weights = propensity_density)
summary(modelB)
```

modelC: using GAM with splines
```{r}
modelC <- gam(cvd_10y_HF ~ s(nRS), family = binomial(), data = data, weights = propensity_density)
summary(modelC)
```



### prediction curve


```{r}
# Predicting probabilities
preds <- predict(modelA, newdata = data.frame(nSES = seq(from = min(data[[treatment]]), to=max(data[[treatment]]), by = 0.1)),
                 type = "response", se.fit = TRUE)

# Standard errors for logistic regression predictions
se <- preds$se.fit

# Confidence intervals using the Normal approximation
data <- data.frame(nSES = seq(from = min(data[[treatment]]), to=max(data[[treatment]]), by = 0.1))
data$fit <- preds$fit
data$lwr <- preds$fit - 1.96 * se
data$upr <- preds$fit + 1.96 * se
```

```{r}
ggplot(data, aes(x = nSES)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = "blue", alpha = 0.2) +
  geom_line(aes(y = fit), color = "blue") +
  geom_hline(yintercept = 0, color = "black") +  
  labs(title = "Logistic Regression: Fitted Probabilities with Confidence Intervals",
       x = "nSES", y = "Estimated Probability") +
  theme_minimal()

```

```{r}
ggsave("jhs_nRS_logit.png", plot = plt,
           path = "../results/prediction_curve/generalized_ipw/cvd_10y_HF",
           width = 10, height = 8, dpi = 300)
```


## loop to generate result

### estimate
```{r, warning=FALSE}
report_df <- data.frame(
  Data = character(),
  Y = character(),
  X = character(),
  moderator = character(),
  intercept = numeric(),
  intercept_pvalue = numeric(),
  X_coef = numeric(),
  X_pvalue = numeric(),
  interaction_coef = numeric(),
  interaction_pvalue = numeric(),
  stringsAsFactors = FALSE 
)

for (combo in all_combos) {
  
  # get values
  data_name = combo$data
  data <- named_datasets[[data_name]]
  
  Y <- combo$Y
  X <- combo$X
  M <- combo$M
  Z <- combo$covariates_final
  
  # generate formula; add interaction based on moderation result
  matches <- which(significant_moderation$data_name == data_name & 
                     significant_moderation$Y == Y & 
                     significant_moderation$X == X & 
                     significant_moderation$M == M)

  if(length(matches) > 0) { # exist moderation, add interaction term in outcome model
    
    formula_ps_no_str <- paste(X, "~ 1")
    formula_ps_no <- as.formula(formula_ps_no_str)
    
    formula_ps_str <- paste(X, "~ ", M, "+" ,paste(Z, collapse=" + "))
    formula_ps <- as.formula(formula_ps_str)
    
    formula_outcome_str <- paste(Y, "~",X,"+",paste(X, M, sep=":"))
    formula_outcome <- as.formula(formula_outcome_str)
    
    moderator <- M
    
  } else { # no moderation
    
    formula_ps_no_str <- paste(X, "~ 1")
    formula_ps_no <- as.formula(formula_ps_no_str)
    
    formula_ps_str <- paste(X, "~ ", M, "+" ,paste(Z, collapse=" + "))
    formula_ps <- as.formula(formula_ps_str)
    
    formula_outcome_str <- paste(Y, "~",X)
    formula_outcome <- as.formula(formula_outcome_str)
    
    moderator <- NA
  }
  
  # estimate
  
  denominator = conditional_densities(data, X, formula_ps_no,formula_ps, use_confounders=T)
  numerator = conditional_densities(data,X, formula_ps_no,formula_ps, use_confounders=F)
  propensity_density = numerator / denominator
  threshold <- quantile(propensity_density, 0.99)
  data <- data[propensity_density <= threshold, ]
  propensity_density <- propensity_density[propensity_density <= threshold]
  outcome_mod <- glm(formula = formula_outcome, data = data, family = binomial(), weights = propensity_density)
  summary_model <- summary(outcome_mod)

  # store model result
  # there will be duplicate rows of results since we dont consider M unless significant moderation
  # remove duplicates later

  coefficients <- summary_model$coefficients

  if(is.na(moderator)) {
    intercept <- round(coefficients["(Intercept)", "Estimate"], digits = 5)
    intercept_pvalue <- round(coefficients["(Intercept)", "Pr(>|z|)"], digits = 5)
    
    X_coef <- round(coefficients[X, "Estimate"], digits = 5)
    X_pvalue <- round(coefficients[X, "Pr(>|z|)"], digits = 5)
    
    interaction_coef <- NA
    interaction_pvalue <- NA
  } else{
    intercept <- round(coefficients["(Intercept)", "Estimate"], digits = 5)
    intercept_pvalue <- round(coefficients["(Intercept)", "Pr(>|z|)"], digits = 5)
    
    X_coef <- round(coefficients[X, "Estimate"], digits = 5)
    X_pvalue <- round(coefficients[X, "Pr(>|z|)"], digits = 5)
      
    last_term_name <- tail(rownames(coefficients), 1)
    interaction_coef <- round(coefficients[last_term_name, "Estimate"], digits = 5)
    interaction_pvalue <- round(coefficients[last_term_name, "Pr(>|z|)"], digits = 5)
  }
  
  new_df <- data.frame(
              Data = data_name,
              Y = Y,
              X = X,
              intercept = intercept,
              intercept_pvalue = intercept_pvalue,
              moderator = moderator,
              X_coef = X_coef,
              X_pvalue = X_pvalue,
              interaction_coef = interaction_coef,
              interaction_pvalue = interaction_pvalue,
              stringsAsFactors = FALSE )

  report_df <- rbind(report_df, new_df)

}

```

```{r}
ipw_final <- report_df %>%
  distinct() 
write.csv(ipw_final, "../results/generalized_IPW/ipw_final_intercept.csv", row.names = FALSE)
```


### plot prediction curve for significant results
```{r}
# ipw_final <- read.csv("../results/generalized_IPW/ipw_final.csv")

plot_ipw <- ipw_final %>%
  filter(X_pvalue <= 0.05) %>% # select significant rows
  filter(row_number() != 9)# remove the not moderated row

```

```{r}
for (i in 1:nrow(plot_ipw)) {
  print(i)
  
  # extract values
  data_name <- plot_ipw[i, "Data"]
  data <- named_datasets[[data_name]]
  Y <- plot_ipw[i, "Y"]
  X <- plot_ipw[i, "X"]
  moderator <- plot_ipw[i, "moderator"]
  X_coef <- plot_ipw[i, "X_coef"]
  X_pvalue <- plot_ipw[i, "X_pvalue"]
  interaction_coef <- plot_ipw[i, 'interaction_coef']
  interaction_pvalue <- plot_ipw[i, "interaction_pvalue"]
  
  # generate formula 
  
  ## covariates
  base_X <- c("nSES", "nPhysFac", "nFavFood", "nRS")
  base_Z <- c('age', 'gender', 'Diabetes', 'hdl', 'totchol', 'sbp')
  base_M <- c("FamIncome", "nutrition", "PhysAct", "currentSmoker", "alc")
  
  if (data_name == "mesa") {
    final_Z = c(base_Z, 'race', 'site')
  } else if (data_name == "mesa_bla") {
    final_Z = c(base_Z, 'site')
  } else if (data_name == "jhs") {
    final_Z = base_Z
  }
  
  ## formula
  formula_ps_no <- as.formula(paste(X, "~ 1"))
  
  formula_ps <- as.formula(paste(X, "~ ", paste(setdiff(base_X,X), collapse = "+"),"+",
                                 paste(base_M, collapse=" + "), "+" ,paste(final_Z, collapse=" + ")))
  
  formula_outcome_str <- ifelse(is.na(moderator), 
                            paste(Y, "~",X), 
                            paste(Y, "~",X,"+",paste(X, moderator, sep=":"))
                            )
  formula_outcome <- as.formula(formula_outcome_str)
  
  # fit model
  denominator = conditional_densities(data, X, formula_ps_no,formula_ps, use_confounders=T)
  numerator = conditional_densities(data,X, formula_ps_no,formula_ps, use_confounders=F)
  propensity_density = numerator / denominator
  threshold <- quantile(propensity_density, 0.99)
  data <- data[propensity_density <= threshold, ]    
  propensity_density <- propensity_density[propensity_density <= threshold]
  outcome_mod <- glm(formula = formula_outcome, data = data, family = binomial(), weights = propensity_density)
    
  # Predicted probabilities and plotting
  if (is.na(moderator)) {
    pred_data <- data.frame(seq(from = min(data[[X]]), to = max(data[[X]]), by = 0.1))
    names(pred_data) <- X
    preds <- predict(outcome_mod, pred_data,type = "response", se.fit = TRUE)
    se <- preds$se.fit
    pred_data$fit <- preds$fit
    pred_data$lwr <- preds$fit - 1.96 * se
    pred_data$upr <- preds$fit + 1.96 * se

    plt <- ggplot(pred_data, aes(x = !!sym(X))) +
      geom_ribbon(aes(ymin = lwr, ymax = upr), fill = "blue", alpha = 0.2) +
      geom_line(aes(y = fit), color = "blue") +
      geom_hline(yintercept = 0, color = "black") +
      labs(title = "Predicted Probabilities of Positive Outcome",
         x = X, y = "Estimated Probability") +
      theme_minimal()

  } else if (moderator == "alc") {
    X_seq <- seq(from = min(data[[X]]), to = max(data[[X]]), by = 0.1)
    X_length <- length(X_seq)
    pred_data <- data.frame(X = rep(X_seq, 2),
                            alc = c(rep(1, X_length), rep(2, X_length)))
    names(pred_data) <- c(X, "alc")
    
    preds <- predict(outcome_mod, pred_data,type = "response", se.fit = TRUE)
    se <- preds$se.fit
    pred_data$fit <- preds$fit
    pred_data$lwr <- preds$fit - 1.96 * se
    pred_data$upr <- preds$fit + 1.96 * se
    
    plt <- ggplot(pred_data, aes(x = !!sym(X), y = fit, 
                                 group = factor(alc, levels = c(1,2), labels = c("No", "Yes")), 
                                 color = factor(alc))) +
      geom_line() +
      geom_hline(yintercept = 0, color = "black") +
      scale_color_manual(values = c("blue", "red"),  labels = c("No", "Yes"),
                         name = "Alcohol Drinking") +
      labs(title = "Predicted Probabilities of Positive Outcome",
         x = X, y = "Estimated Probability") +
      theme_minimal()

  } else if (moderator == "FamIncome") {
    X_seq <- seq(from = min(data[[X]]), to = max(data[[X]]), by = 0.1)
    X_length <- length(X_seq)
    pred_data <- data.frame(X = rep(X_seq, 4),
                            FamIncome = c(rep(1, X_length), rep(2, X_length), rep(3, X_length), rep(4, X_length)))
    names(pred_data) <- c(X, "FamIncome")
    
    preds <- predict(outcome_mod, pred_data,type = "response", se.fit = TRUE)
    se <- preds$se.fit
    pred_data$fit <- preds$fit
    pred_data$lwr <- preds$fit - 1.96 * se
    pred_data$upr <- preds$fit + 1.96 * se
    
    plt <- ggplot(pred_data, aes(x = !!sym(X), y = fit, 
                                 group = factor(FamIncome, levels = c(1,2,3,4)), 
                                 color = factor(FamIncome))) +
      geom_line() +
      geom_hline(yintercept = 0, color = "black") +
      scale_color_manual(values = c("red", "blue", "green", "orange"),  
                         labels = c("$0-11,999", "$12,000-24,999", "$25,000-74,999", "$75,000+"),
                         name = "Family Income") +
      labs(title = "Predicted Probabilities of Positive Outcome",
         x = X, y = "Estimated Probability") +
      theme_minimal()

  } else if (moderator == "PhysAct") {
    X_seq <- seq(from = min(data[[X]]), to = max(data[[X]]), by = 0.1)
    X_length <- length(X_seq)
    pred_data <- data.frame(X = rep(X_seq, 3),
                            PhysAct = c(rep(1, X_length), rep(2, X_length), rep(3, X_length)))
    names(pred_data) <- c(X, "PhysAct")
    
    preds <- predict(outcome_mod, pred_data,type = "response", se.fit = TRUE)
    se <- preds$se.fit
    pred_data$fit <- preds$fit
    pred_data$lwr <- preds$fit - 1.96 * se
    pred_data$upr <- preds$fit + 1.96 * se
    
    plt <- ggplot(pred_data, aes(x = !!sym(X), y = fit, 
                                 group = factor(PhysAct, levels = c(1,2,3)),  
                                 color = factor(PhysAct))) +
      geom_line() +
      geom_hline(yintercept = 0, color = "black") +
      scale_color_manual(values = c("blue", "red","green"),  labels = c("Poor", "Intermediate","Ideal"),
                         name = "Physical Activity") +
      labs(title = "Predicted Probabilities of Positive Outcome",
         x = X, y = "Estimated Probability") +
      theme_minimal()
  } else {
    print("error")
  }
  
  # export plot
  ggsave(paste0(data_name,"_",Y,"_",X,".png"), plot = plt,
           path = "../results/generalized_IPW/significant_prediction_curve",
           width = 8, height = 6, dpi = 300)
}

```
**test**
```{r}
for (i in 4) {
  print(i)
  
  # extract values
  data_name <- plot_ipw[i, "Data"]
  data <- named_datasets[[data_name]]
  Y <- plot_ipw[i, "Y"]
  X <- plot_ipw[i, "X"]
  moderator <- plot_ipw[i, "moderator"]
  X_coef <- plot_ipw[i, "X_coef"]
  X_pvalue <- plot_ipw[i, "X_pvalue"]
  interaction_coef <- plot_ipw[i, 'interaction_coef']
  interaction_pvalue <- plot_ipw[i, "interaction_pvalue"]
  
  # generate formula 
  
  ## covariates
  base_X <- c("nSES", "nPhysFac", "nFavFood", "nRS")
  base_Z <- c('age', 'gender', 'Diabetes', 'hdl', 'totchol', 'sbp')
  base_M <- c("FamIncome", "nutrition", "PhysAct", "currentSmoker", "alc")
  
  if (data_name == "mesa") {
    final_Z = c(base_Z, 'race', 'site')
  } else if (data_name == "mesa_bla") {
    final_Z = c(base_Z, 'site')
  } else if (data_name == "jhs") {
    final_Z = base_Z
  }
  
  ## formula
  formula_ps_no <- as.formula(paste(X, "~ 1"))
  
  formula_ps <- as.formula(paste(X, "~ ", paste(setdiff(base_X,X), collapse = "+"),"+",
                                 paste(base_M, collapse=" + "), "+" ,paste(final_Z, collapse=" + ")))
  
  formula_outcome_str <- ifelse(is.na(moderator), 
                            paste(Y, "~",X), 
                            paste(Y, "~",X,"+",paste(X, moderator, sep=":"))
                            )
  formula_outcome <- as.formula(formula_outcome_str)
  
  # fit model
  denominator = conditional_densities(data, X, formula_ps_no,formula_ps, use_confounders=T)
  numerator = conditional_densities(data,X, formula_ps_no,formula_ps, use_confounders=F)
  propensity_density = numerator / denominator
  threshold <- quantile(propensity_density, 0.99)
  data <- data[propensity_density <= threshold, ]    
  propensity_density <- propensity_density[propensity_density <= threshold]
  outcome_mod <- glm(formula = formula_outcome, data = data, family = binomial(), weights = propensity_density)
    
  # Predicted probabilities and plotting
  if (is.na(moderator)) {
    pred_data <- data.frame(seq(from = min(data[[X]]), to = max(data[[X]]), by = 0.1))
    names(pred_data) <- X
    preds <- predict(outcome_mod, pred_data,type = "response", se.fit = TRUE)
    se <- preds$se.fit
    pred_data$fit <- preds$fit
    pred_data$lwr <- preds$fit - 1.96 * se
    pred_data$upr <- preds$fit + 1.96 * se

    plt <- ggplot(pred_data, aes(x = !!sym(X))) +
      geom_ribbon(aes(ymin = lwr, ymax = upr), fill = "blue", alpha = 0.2) +
      geom_line(aes(y = fit), color = "blue") +
      geom_hline(yintercept = 0, color = "black") +
      labs(title = "Predicted Probabilities of Positive Outcome",
         x = X, y = "Estimated Probability") +
      theme_minimal()

  } else if (moderator == "alc") {
    X_seq <- seq(from = min(data[[X]]), to = max(data[[X]]), by = 0.1)
    X_length <- length(X_seq)
    pred_data <- data.frame(X = rep(X_seq, 2),
                            alc = c(rep(1, X_length), rep(2, X_length)))
    names(pred_data) <- c(X, "alc")
    
    preds <- predict(outcome_mod, pred_data,type = "response", se.fit = TRUE)
    se <- preds$se.fit
    pred_data$fit <- preds$fit
    pred_data$lwr <- preds$fit - 1.96 * se
    pred_data$upr <- preds$fit + 1.96 * se
    
    plt <- ggplot(pred_data, aes(x = !!sym(X), y = fit, 
                                 group = factor(alc, levels = c(1,2), labels = c("No", "Yes")), 
                                 color = factor(alc))) +
      geom_line() +
      geom_hline(yintercept = 0, color = "black") +
      scale_color_manual(values = c("blue", "red"),  labels = c("No", "Yes"),
                         name = "Alcohol Drinking") +
      labs(title = "Predicted Probabilities of Positive Outcome",
         x = X, y = "Estimated Probability") +
      theme_minimal()

  } else if (moderator == "FamIncome") {
    X_seq <- seq(from = min(data[[X]]), to = max(data[[X]]), by = 0.1)
    X_length <- length(X_seq)
    pred_data <- data.frame(X = rep(X_seq, 1),
                            FamIncome = c(rep(4, X_length)))
    names(pred_data) <- c(X, "FamIncome")
    
    preds <- predict(outcome_mod, pred_data,type = "response", se.fit = TRUE)
    se <- preds$se.fit
    pred_data$fit <- preds$fit
    pred_data$lwr <- preds$fit - 1.96 * se
    pred_data$upr <- preds$fit + 1.96 * se
    
    plt <- ggplot(pred_data, aes(x = !!sym(X), y = fit, 
                                 group = factor(FamIncome, levels = c(1,2,3,4)), 
                                 color = factor(FamIncome))) +
      geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2) +
      geom_line() +
      geom_hline(yintercept = 0, color = "black") +
      scale_color_manual(values = c("orange"),  
                         labels = c("$75,000+"), 
                         name = "Family Income") +
      labs(title = "Predicted Probabilities of Positive Outcome",
         x = X, y = "Estimated Probability") +
      theme_minimal()

  } else if (moderator == "PhysAct") {
    X_seq <- seq(from = min(data[[X]]), to = max(data[[X]]), by = 0.1)
    X_length <- length(X_seq)
    pred_data <- data.frame(X = rep(X_seq, 1),
                            PhysAct = c(rep(1, X_length)))
    names(pred_data) <- c(X, "PhysAct")
    
    preds <- predict(outcome_mod, pred_data,type = "response", se.fit = TRUE)
    se <- preds$se.fit
    pred_data$fit <- preds$fit
    pred_data$lwr <- preds$fit - 1.96 * se
    pred_data$upr <- preds$fit + 1.96 * se
    
    plt <- ggplot(pred_data, aes(x = !!sym(X), y = fit, 
                                 group = factor(PhysAct),  
                                 color = factor(PhysAct))) +
      geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2) +
      geom_line() +
      geom_hline(yintercept = 0, color = "black") +
      scale_color_manual(values = c("blue"),  labels = c("Poor"),
                         name = "Physical Activity") +
      labs(title = "Predicted Probabilities of Positive Outcome",
         x = X, y = "Estimated Probability") +
      theme_minimal()
  } else {
    print("error")
  }
  
  # export plot
  ggsave(paste0(data_name,"_",Y,"_",X,"_4",".png"), plot = plt,
           path = "../results/generalized_IPW/test_subgroup",
           width = 8, height = 6, dpi = 300)
}

```

