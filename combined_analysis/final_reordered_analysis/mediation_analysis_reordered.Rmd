---
title: "Mediation analysis"
author: "Xiaoting Chen"
date: "2024-08-22"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## Prep

### packages
```{r, warning=FALSE}
library(readr)
library(tidyr)
library(ggplot2)
library(dplyr)
library(stats) # handle normal distribution calculations
library(splines) # using splines
library(mgcv)
library(bda) # sobel test
```

### data

```{r}
all_combos <- readRDS("all_combos.rds")
```

```{r}
analysis_feature_mesa <- c('cvd_10y_HF', 'cvd_10y_noHF', 'nSES', 'nFavFood', 'nPhysFac', 'nRS',
                      'FamIncome', 'nutrition', 'PhysAct', 'currentSmoker', 'alc',
                      'age', 'gender', 'Diabetes', 'hdl', 'totchol', 'sbp',
                      'site', 'race')

analysis_feature_jhs <- c('cvd_10y_HF', 'cvd_10y_noHF', 
                      'nSES', 'nFavFood', 'nPhysFac', 'nRS',
                      'FamIncome', 'nutrition', 'PhysAct', 'currentSmoker', 'alc',
                      'age', 'gender', 'Diabetes', 'hdl', 'totchol', 'sbp')

ind_feature_map <- c('0' = 1, '1' = 2, '2' = 3)
```

```{r}
mesa_std <- read.csv('../../data_processed/MESA/mesa_std.csv')

mesa_std <- mesa_std %>%
  select(analysis_feature_mesa) %>%
  mutate(# # treat ind behavirol variables as conitnuous, avoid partial significant 
    Diabetes = as.factor(Diabetes),
         site = as.factor(site),
         race = as.factor(race)) %>%
  mutate( # recode to avoid 0
    nutrition = recode(nutrition, !!!ind_feature_map),
    PhysAct = recode(PhysAct, !!!ind_feature_map),
    currentSmoker = recode(currentSmoker, !!!ind_feature_map),
    alc = recode(alc, !!!ind_feature_map)
  )

```

```{r}
jhs_std <- read.csv('../../data_processed/JHS/jhs_std.csv')

jhs_std <- jhs_std %>%
  select(analysis_feature_jhs) %>%
  mutate(# # treat ind behavirol variables as conitnuous, avoid partial significant 
    Diabetes = as.factor(Diabetes)) %>%
  mutate( # recode to avoid 0
    nutrition = recode(nutrition, !!!ind_feature_map),
    PhysAct = recode(PhysAct, !!!ind_feature_map),
    currentSmoker = recode(currentSmoker, !!!ind_feature_map),
    alc = recode(alc, !!!ind_feature_map)
  )
```

```{r}
named_datasets <- list(mesa = mesa_std, jhs = jhs_std)
names(named_datasets) <- c("mesa", "jhs")
```

### function    
```{r}
conditional_densities <- function(data, treatment, formula_ps_no_con, formula_ps_con, use_confounders = TRUE) {

  formula <- if(use_confounders) formula_ps_con else formula_ps_no_con
  
  # Fit the linear model
  model <- lm(as.formula(formula), data = data)
  
  # Calculate the fitted values and standard deviation of residuals
  fitted_values <- fitted(model)
  resid_std <- sd(resid(model))
  
  # Calculate the density of treatment under a normal distribution with parameters from the model
  densities <- dnorm(data[[treatment]], mean = fitted_values, sd = resid_std)
  
  # Return the densities as a vector indexed similarly to the fitted values
  return(setNames(densities, names(fitted_values)))
}

```



## result generation

**Steps:**\\
Y ~ b0 + b1X + bZ + e
M ~ b0 + b2X + e\\
Y ~ b0 + b3X + b4M + bZ + e\\

### bootstrap to obtain ci
```{r, warning=FALSE, message=FALSE}
n_boot <- 1000
set.seed(123)

med_report_df_boot <- data.frame(
  boot = numeric(),
  Data = character(),
  Y = character(),
  X = character(),
  Me = character(),
  b1 = numeric(),
  b2 = numeric(),
  b3 = numeric(),
  b4 = numeric(),
  b2_b4 = numeric(),
  stringsAsFactors = FALSE 
)

for (i in seq_along(all_combos)) {
  
  print(i)  
  combo <- all_combos[[i]]
  
  # get values
  data_name = combo$data
  data <- named_datasets[[data_name]]
  Y_name <- combo$Y
  X_name <- combo$X
  M_name <- combo$M
  Z <- combo$covariates
  
  # generate formula for mediation test
  formula_X_to_Y <- paste(Y_name, "~", X_name)
  formula_X_to_Y <- as.formula(formula_X_to_Y)
  formula_X_to_M <- paste(M_name, "~", X_name)
  formula_X_to_M <- as.formula(formula_X_to_M)
  formula_XM_to_Y <- paste(Y_name, "~", X_name, "+", M_name, "+", paste(Z, collapse=" + "))
  formula_XM_to_Y <- as.formula(formula_XM_to_Y)

  # Bootstrap to get CIs

  for (j in 1:n_boot) {
    # Resample 
    indices <- sample(1:nrow(data), replace = TRUE)
    boot_data <- data[indices, ]
    
    # fit the models on the bootstrap sample
    boot_mod_X_to_Y <- glm(formula = formula_X_to_Y, data = boot_data)
    boot_mod_X_to_M <- glm(formula = formula_X_to_M, data = boot_data)
    boot_mod_XM_to_Y <- glm(formula = formula_XM_to_Y, data = boot_data, family = binomial())
    
    # Extract coefficients
    boot_coef_X_to_Y <- coef(boot_mod_X_to_Y)
    boot_coef_X_to_M <- coef(boot_mod_X_to_M)
    boot_coef_XM_to_Y <- coef(boot_mod_XM_to_Y)
    
    new_df <- data.frame(
                boot = j,
                Data = data_name,
                Y = Y_name,
                X = X_name,
                Me = M_name,
                b1 = boot_coef_X_to_Y[X_name],
                b2 = boot_coef_X_to_M[X_name],
                b3 = boot_coef_XM_to_Y[X_name],
                b4 = boot_coef_XM_to_Y[M_name], 
                b2_b4 = boot_coef_X_to_M[X_name]*boot_coef_XM_to_Y[M_name],
                stringsAsFactors = FALSE )
  
    med_report_df_boot <- rbind(med_report_df_boot, new_df)
  }
  
}
```

```{r}
write.csv(med_report_df_boot, "../../results/reordered_results/mediation/med_report_df_boot.csv", row.names = FALSE)
```


### summarize mediation result 

```{r}
boot_summarized <- med_report_df_boot %>%
  group_by(Data, Y, X, Me) %>%
  summarise(b1_mean = mean(b1),
            b1_ci_lwr = quantile(b1, 0.025),
            b1_ci_upr = quantile(b1, 0.975),
            b2_mean = mean(b2),
            b2_ci_lwr = quantile(b2, 0.025),
            b2_ci_upr = quantile(b2, 0.975),
            b3_mean = mean(b3),
            b3_ci_lwr = quantile(b3, 0.025),
            b3_ci_upr = quantile(b3, 0.975),
            b4_mean = mean(b4),
            b4_ci_lwr = quantile(b4, 0.025),
            b4_ci_upr = quantile(b4, 0.975),
            b2_b4_mean = mean(b2_b4),
            b2_b4_ci_lwr = quantile(b2_b4, 0.025),
            b2_b4_ci_upr = quantile(b2_b4, 0.975))

write.csv(boot_summarized, "../../results/reordered_results/mediation/med_boot_summarized.csv", row.names = FALSE)
```

```{r}
med_boot_sig <- boot_summarized %>%
  filter(b2_b4_ci_lwr*b2_b4_ci_upr > 0) %>%
  mutate(
    TotalEffect_b1 = sprintf("%.3f [%.3f, %.3f]", b1_mean, b1_ci_lwr, b1_ci_upr),
    b2 = sprintf("%.3f [%.3f, %.3f]", b2_mean, b2_ci_lwr, b2_ci_upr),
    DirectEffect_b3 = sprintf("%.3f [%.3f, %.3f]", b3_mean, b3_ci_lwr, b3_ci_upr),
    b4 = sprintf("%.3f [%.3f, %.3f]", b4_mean, b4_ci_lwr, b4_ci_upr),
    IndirectEffect_b2_b4 = sprintf("%.3f [%.3f, %.3f]", b2_b4_mean, b2_b4_ci_lwr, b2_b4_ci_upr)
  )

write.csv(med_boot_sig, "../../results/reordered_results/mediation/med_boot_sig.csv", row.names = FALSE)
```


### sobel test
```{r}
sobel_df <- data.frame(
  Data = character(),
  Y = character(),
  X = character(),
  mediator = character(),
  b1 = numeric(),
  b1_pvalue = numeric(),
  b2 = numeric(),
  b2_pvalue = numeric(),
  b3 = numeric(),
  b3_pvalue = numeric(),
  b4 = numeric(),
  b4_pvalue = numeric(),
  b2_b4 = numeric(),
  sobel_pvalue = numeric()
)

for (combo in all_combos) {
  
  # get values
  data_name = combo$data
  data <- named_datasets[[data_name]]
  Y <- combo$Y
  X <- combo$X
  M <- combo$M
  Z <- combo$covariates_final
  
  # generate formula
  ## formula for generating weights
  formula_ps_no_str <- paste(X, "~ 1")
  formula_ps_no <- as.formula(formula_ps_no_str)
  formula_ps_str <- paste(X, "~ ", M, "+" ,paste(Z, collapse=" + "))
  formula_ps <- as.formula(formula_ps_str)
  ## formula for mediation test
  formula_X_to_Y <- paste(Y, "~",X, "+", paste(Z, collapse=" + "))
  formula_X_to_Y <- as.formula(formula_X_to_Y)
  formula_X_to_M <- paste(M, "~", X)
  formula_X_to_M <- as.formula(formula_X_to_M)
  formula_XM_to_Y <- paste(Y, "~",X, "+", M, "+", paste(Z, collapse=" + "))
  formula_XM_to_Y <- as.formula(formula_XM_to_Y)
  
  # estimate weights
  denominator = conditional_densities(data, X, formula_ps_no,formula_ps, use_confounders=T)
  numerator = conditional_densities(data,X, formula_ps_no,formula_ps, use_confounders=F)
  propensity_density = numerator / denominator
  threshold <- quantile(propensity_density, 0.99)
  data <- data[propensity_density <= threshold, ]
  propensity_density <- propensity_density[propensity_density <= threshold]
  
  # run the 3 models
  
  ## Y ~ X + Z
  mod_X_to_Y <- glm(formula = formula_X_to_Y, data = data, family = binomial(), weights = propensity_density)
  summary_X_to_Y <- summary(mod_X_to_Y)
  coef_X_to_Y <- summary_X_to_Y$coefficients
  ## M ~ X
  mod_X_to_M <- glm(formula = formula_X_to_M, data = data, weights = propensity_density)
  summary_X_to_M <- summary(mod_X_to_M)
  coef_X_to_M <- summary_X_to_M$coefficients
  se_X_to_M <- summary_X_to_M$coefficients[X, "Std. Error"]
  ## Y ~ X + M +Z
  mod_XM_to_Y <- glm(formula = formula_XM_to_Y, data = data, family = binomial(), weights = propensity_density)
  summary_XM_to_Y <- summary(mod_XM_to_Y)
  coef_XM_to_Y <- summary_XM_to_Y$coefficients
  se_XM_to_Y <- summary_XM_to_Y$coefficients[M, "Std. Error"]

  # extract and calculate model result
  b1 <- round(coef_X_to_Y[X, "Estimate"], digits = 5)
  b1_pvalue <- round(coef_X_to_Y[X, "Pr(>|z|)"], digits = 5)
  b2 <- round(coef_X_to_M[X, "Estimate"], digits = 5)
  b2_pvalue <- round(coef_X_to_M[X, "Pr(>|t|)"], digits = 5)
  b3 <- round(coef_XM_to_Y[X, "Estimate"], digits = 5)
  b3_pvalue <- round(coef_XM_to_Y[X, "Pr(>|z|)"], digits = 5)
  b4 <- round(coef_XM_to_Y[M, "Estimate"], digits = 5)
  b4_pvalue <- round(coef_XM_to_Y[M, "Pr(>|z|)"], digits = 5)
  b2_b4 <- round(b2 * b4, digits = 5)
  
  sobel_se <- sqrt((b4^2 * se_X_to_M^2) + (b2^2 * se_XM_to_Y^2))
  sobel_z <- (b2 * b4) / sobel_se
  sobel_pvalue <- 2 * (1 - pnorm(abs(sobel_z)))
  
  # store result
  new_df <- data.frame(
    Data = data_name,
    Y = Y,
    X = X,
    mediator = M,
    b1 = b1,
    b1_pvalue = b1_pvalue,
    b2 = b2,
    b2_pvalue = b2_pvalue,
    b3 = b3,
    b3_pvalue = b3_pvalue,
    b4 = b4,
    b4_pvalue = b4_pvalue,
    b2_b4 = b2_b4,
    sobel_pvalue = sobel_pvalue
  )
  
  sobel_df <- rbind(sobel_df, new_df)

}


# write.csv(sobel_df, "../results/mediation_result/mediation_sobel_240816.csv", row.names = FALSE)
```


significant mediators 
```{r}
coef_ci <- read.csv("../results/mediation_result/mediation_bootstrap_ci_240816.csv")
sobel_df <- read.csv("../results/mediation_result/mediation_sobel_240816.csv")

# Baron and Kenny
# Y ~ X (b1); M ~ X (b2); Y ~ M (b4)
med_BK_ci <- coef_ci %>%
  filter((b1_ci_lwr * b1_ci_upr > 0) & (b2_ci_lwr * b2_ci_upr > 0) & (b4_ci_lwr * b4_ci_upr > 0))
## 0 result
med_BK_coef_sobel <- sobel_df %>%
  filter((b1_pvalue <= 0.05) & (b2_pvalue <= 0.05) & (b4_pvalue <= 0.05))
## 2 results
med_BK_sobel <- sobel_df %>% 
  filter(sobel_pvalue <= 0.05)
## 6 rsults

# Zhao
# b2*b4
med_zhao <- coef_ci %>%
  filter(b2_b4_ci_lwr * b2_b4_ci_upr > 0)
## 3 results

# MacKinnon
# M ~ X (b2); Y ~ M (b4)
med_mackinnon <- coef_ci %>%
  filter((b2_ci_lwr * b2_ci_upr > 0) & (b4_ci_lwr * b4_ci_upr > 0))
## 3 results
```


