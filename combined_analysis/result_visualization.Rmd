---
title: "plots"
author: "Xiaoting Chen"
date: "2023-09-19"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(dplyr)
```


## Mediation 

### data

```{r}
setwd("../results/mediation_Mar5")

# List all CSV files in the directory
files <- list.files(pattern = "\\.csv$")

# Function to read each file and add a column with the file name
read_csv_add_filename <- function(file) {
  data <- read.csv(file, stringsAsFactors = FALSE)
  data$SourceFile <- file # Add a new column with the file name
  return(data)
}

# Read each CSV file, add file name, and combine them into one data frame
mediation <- do.call(rbind, lapply(files, read_csv_add_filename)) %>%
  separate(col = SourceFile, into = c("dat1", "dat2","nb_exposure", "ind_mediator","med"), sep = "_") %>%
  select(-c(1,7,8,11)) %>%
  filter(Effect != "Prop. Mediated")

mediation$Effect <- factor(mediation$Effect, levels =unique(mediation$Effect))

```


### plotting
```{r}
plt_dat <- mediation[(mediation$nb_exposure == "nRS")&(mediation$Data == "jhs_std"), ]

plot <- ggplot(plt_dat, aes(x = Estimate, y = ind_mediator, color = Effect)) +
            geom_point(position = position_dodge(width = 0.5), size=3.5) +  
            geom_errorbarh(aes(xmin = X95_CI_Lower, xmax = X95_CI_Upper), 
                           height = 0.2, position = position_dodge(width = 0.5), size =2) +
            labs(x = "Effect",
                 y = "Individual potential mediator") +
            geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
            theme_minimal() +
            ggtitle("nRS as exposure using jhs_std data") +
            theme(axis.text = element_text(size = 15),
                  axis.title = element_text(size = 15),
                  legend.text = element_text(size = 15),
                  legend.title = element_text(size = 15),
                  plot.title = element_text(size = 20))

ggsave("nRS_jhs_std.png", plot = plot, path = "../results/mediation_plots_Mar5", width = 10, height = 8, dpi = 300)
```


## Moderation

### data

```{r}
setwd("../results/moderation_Mar5")

mod_files <- list.files(pattern = "\\.csv$")

read_csv <- function(file) {
  data <- read.csv(file, stringsAsFactors = FALSE)
  return(data)
}

# Read each CSV file, and combine them into one data frame
moderation <- do.call(rbind, lapply(mod_files, read_csv)) %>%
  separate(col = Bootstrap.Result.Name, sep = "_", 
           into = c("bootstrap", "number", "nb_exposure", "ind_moderator")) %>%
  select(-c(1,3,4)) 
```


#### plotting
```{r}
plt_dat <- moderation[(moderation$nb_exposure == "nRS"), ]

plot <- ggplot(plt_dat, aes(x = Mean, y = ind_moderator, color = Data)) +
            geom_point(position = position_dodge(width = 0.5), size=3.5) +  
            geom_errorbarh(aes(xmin = X2.5., xmax = X97.5.), 
                           height = 0.2, position = position_dodge(width = 0.5), size =2) +
            labs(x = "Estimated Coefficient of Interaction Term",
                 y = "Individual potential moderator") +
            geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
            theme_minimal() +
            ggtitle("Moderation of individual features on nRS") +
            theme(axis.text = element_text(size = 15),
                  axis.title = element_text(size = 15),
                  legend.text = element_text(size = 15),
                  legend.title = element_text(size = 15),
                  plot.title = element_text(size = 20))


ggsave("moderation_nRS.png", plot = plot, path = "../results/moderation_plots_Mar5", width = 10, height = 8, dpi = 300)
```


## Missingness

Data
```{r}
mesa_raw <- read.csv("../data_processed/MESA/Y_BaselineX_raw_full.csv") %>%
  select(c("site","nSES","nRS","nFavFood","nPhysFac",
                     "FamIncome","nutrition","PhysAct","currentSmoker","alc",
                     "age","race","gender","Diabetes","hdl","totchol","sbp"))

```


```{r}

# Step 1: Reshape the data to long format
long_df <- mesa_raw %>%
  pivot_longer(cols = -site, names_to = "variable")

# Calculate the total observations per site
site_counts <- mesa_raw %>%
  group_by(site) %>%
  summarise(total_observations = n(), .groups = 'drop')

# Step 2: Calculate missing values per site and variable
missing_counts <- long_df %>%
  group_by(site, variable) %>%
  summarise(missing_count = sum(is.na(value)), .groups = 'drop')

# Step 3: Join the site_counts to get total observations in the missing_counts dataframe
missing_counts <- missing_counts %>%
  left_join(site_counts, by = "site")

# Step 4: Rename the 'site' column to the desired format
missing_counts <- missing_counts %>%
  mutate(site = paste("site", site, "(n=", total_observations, ")", sep = "_"))

# Pivot to wide format
wide_df <- missing_counts %>%
  select(-total_observations) %>%
  pivot_wider(names_from = site, values_from = missing_count, values_fill = list(missing_count = 0))

# Step 5: Calculate total missing values for each variable
total_missing <- long_df %>%
  group_by(variable) %>%
  summarise(total_missing = sum(is.na(value)), .groups = 'drop')

# Step 6: Combine the total missing with the wide-format data
final_table <- left_join(wide_df, total_missing, by = "variable")

print(final_table)

write.csv(final_table, "../results/missingness_mesa.csv", row.names = FALSE)
```
